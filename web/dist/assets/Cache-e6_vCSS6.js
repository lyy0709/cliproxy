import{_ as vt,r,a as ft,q as O,o as pt,N as bt,c as o,b as t,f as y,z as gt,p as C,s as x,v as $,t as l,d as yt,P as H,e as _,F as R,x as j,L as _t,w as mt,T as ht,l as v,E as p,n as a}from"./index-CQyKkE5B.js";const kt={class:"cache-page"},wt={class:"config-card"},Ct={class:"config-row"},xt={class:"config-item"},Lt={class:"input-group"},At={class:"config-item"},Mt={class:"input-group"},Tt={class:"config-item"},$t={class:"input-group"},Bt={class:"config-item"},St={class:"input-group"},Ut={class:"config-item action"},Vt=["disabled"],Pt={class:"tabs-container"},Nt={class:"tabs"},Ft={class:"tab-content"},zt={class:"table-card"},It={class:"card-toolbar"},Et={class:"search-box"},Kt=["disabled"],Dt={class:"table-container"},Ht={class:"data-table"},Rt={key:0},jt={class:"session-id"},qt={class:"badge badge-warning"},Wt={key:0,class:"api-key-code"},Gt={key:1,class:"text-muted"},Jt={class:"badge badge-info"},Ot={class:"model-cell"},Qt=["onClick"],Xt={key:0,class:"loading-state"},Yt={key:1,class:"empty-state"},Zt={key:0,class:"pagination-wrap"},te={class:"pagination-info"},ee={class:"pagination-controls"},ne={class:"page-btns"},se=["disabled"],le={class:"page-current"},ae=["disabled"],oe={class:"tab-content"},ie={class:"table-card"},re={class:"table-container"},ue={class:"data-table"},ce={key:0},de={class:"badge badge-warning"},ve={class:"reason-cell"},fe={class:"ttl-badge danger"},pe=["onClick"],be={key:0,class:"loading-state"},ge={key:1,class:"empty-state"},ye={class:"tab-content"},_e={class:"concurrency-grid"},me={class:"table-card"},he={class:"card-toolbar"},ke={class:"toolbar-title"},we={class:"table-container compact"},Ce={class:"data-table"},xe=["onClick"],Le={key:0,class:"empty-state small"},Ae={class:"modal modal-sm"},Me={class:"modal-footer"},Te={__name:"Cache",setup($e){const I=r(!1),B=r(!1),u=ft({session_ttl:60,session_renewal_ttl:14,unavailable_ttl:5,concurrency_ttl:5}),b=r("sessions"),L=r(!1),g=r([]),m=r(0),k=r(1),w=r(20),S=r(""),A=r({}),E=r({}),M=r(!1),U=r([]),T=r(!1),K=O(()=>{const n=new Map;return g.value.forEach(e=>{n.has(e.account_id)||n.set(e.account_id,{account_id:e.account_id,concurrency:0,max_concurrency:5}),n.get(e.account_id).concurrency++}),Array.from(n.values())}),Q=O(()=>{if(!S.value)return g.value;const n=S.value.toLowerCase();return g.value.filter(e=>{var s;return((s=e.session_id)==null?void 0:s.toLowerCase().includes(n))||P(e.account_id).toLowerCase().includes(n)||G(e.api_key_id).toLowerCase().includes(n)})});let V=null;function q(n){return n?new Date(n).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"-"}function X(n,e){return n>=e?"concurrency-danger":n>=e*.8?"concurrency-warning":"concurrency-success"}function Y(n){if(!n)return"-";if(n.startsWith("apikey:")){const e=n.split(":");return e.length>=3?e.slice(2).join(":"):`Key#${e[1]}`}return n}function W(n){return!n||n<=0?"已过期":n<60?`${n}秒`:n<3600?`${Math.floor(n/60)}分${n%60}秒`:`${Math.floor(n/3600)}时${Math.floor(n%3600/60)}分`}function Z(n){return!n||n<=0?"danger":n<300?"warning":"success"}function P(n){return n?A.value[n]||`#${n}`:"-"}function G(n){return n?E.value[n]||"sk-...":"-"}function tt(){}async function J(){I.value=!0;try{const e=(await v.getCacheConfig()).data||{};u.session_ttl=e.session_ttl||60,u.session_renewal_ttl=e.session_renewal_ttl||14,u.unavailable_ttl=e.unavailable_ttl||5,u.concurrency_ttl=e.concurrency_ttl||5}catch(n){console.error("Failed to fetch config:",n)}finally{I.value=!1}}async function et(){B.value=!0;try{await v.updateCacheConfig(u),p.success("配置已保存")}catch{p.error("保存失败")}finally{B.value=!1}}async function f(){var n,e;L.value=!0;try{const s=(k.value-1)*w.value,i=await v.getCacheSessions({offset:s,limit:w.value});g.value=((n=i.data)==null?void 0:n.sessions)||[],m.value=((e=i.data)==null?void 0:e.total)||0;const h=[...new Set(g.value.map(F=>F.account_id).filter(Boolean))],d=[...new Set(g.value.map(F=>F.api_key_id).filter(Boolean))];await nt(h),await st(d)}catch(s){console.error("Failed to load sessions:",s)}finally{L.value=!1}}async function nt(n){var e,s,i;if(n.length)try{const h=n.filter(c=>c&&!A.value[c]);if(!h.length)return;const d=await v.getAccounts({page:1,page_size:1e3});(((e=d.data)==null?void 0:e.items)||((s=d.data)==null?void 0:s.list)||[]).forEach(c=>{c!=null&&c.id&&(A.value[c.id]=c.name||`账号${c.id}`)});for(const c of h)if(!A.value[c])try{const z=await v.getAccount(c);(i=z.data)!=null&&i.id&&(A.value[z.data.id]=z.data.name||`账号${z.data.id}`)}catch{}}catch(h){console.error("Failed to load account names:",h)}}async function st(n){var s;if(!n.length)return;const e=n.filter(i=>i&&!E.value[i]);if(e.length)try{(((s=(await v.adminLookupAPIKeys(e)).data)==null?void 0:s.items)||[]).forEach(d=>{d!=null&&d.id&&d.key_prefix&&(E.value[d.id]=d.key_prefix)})}catch(i){console.error("Failed to load API key labels:",i)}}async function lt(n){try{await v.removeCacheSession(n),p.success("会话已移除"),f()}catch{p.error("移除失败")}}function at(){T.value=!0}async function ot(){try{await v.clearCache("sessions"),p.success("所有会话已清除"),g.value=[],m.value=0,T.value=!1}catch{p.error("清除失败")}}async function N(){var n;M.value=!0;try{const e=await v.getUnavailableAccounts();U.value=((n=e.data)==null?void 0:n.accounts)||[]}catch(e){console.error("Failed to load unavailable accounts:",e)}finally{M.value=!1}}async function it(n){try{await v.clearAccountUnavailable(n),p.success("已恢复账号"),N()}catch{p.error("操作失败")}}async function rt(n){try{await v.resetAccountConcurrency(n),p.success("已重置"),f()}catch{p.error("重置失败")}}function D(n){b.value=n,n==="sessions"?f():n==="unavailable"?N():n==="concurrency"&&f()}function ut(){J(),f(),b.value==="unavailable"&&N()}function ct(){V=setInterval(()=>{b.value==="sessions"&&f()},3e4)}function dt(){V&&(clearInterval(V),V=null)}return pt(()=>{J(),f(),ct()}),bt(()=>{dt()}),(n,e)=>(a(),o("div",kt,[t("div",{class:"page-header"},[e[14]||(e[14]=t("div",{class:"header-content"},[t("h1",{class:"page-title"},"缓存管理"),t("p",{class:"page-subtitle"},"管理会话缓存、不可用账号和并发控制")],-1)),t("button",{class:"btn btn-outline",onClick:ut},[...e[13]||(e[13]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("polyline",{points:"23,4 23,10 17,10"}),t("path",{d:"M20.49 15a9 9 0 11-2.12-9.36L23 10"})],-1),C(" 刷新 ",-1)])])]),t("div",wt,[e[23]||(e[23]=t("div",{class:"card-header"},[t("h3",null,"缓存配置")],-1)),t("div",{class:x(["config-form",{loading:I.value}])},[t("div",Ct,[t("div",xt,[e[16]||(e[16]=t("label",null,"粘性会话 TTL",-1)),t("div",Lt,[y(t("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>u.session_ttl=s),type:"number",min:"1",max:"1440",class:"form-input"},null,512),[[$,u.session_ttl,void 0,{number:!0}]]),e[15]||(e[15]=t("span",{class:"input-suffix"},"分钟",-1))])]),t("div",At,[e[18]||(e[18]=t("label",null,"会话续期阈值",-1)),t("div",Mt,[y(t("input",{"onUpdate:modelValue":e[1]||(e[1]=s=>u.session_renewal_ttl=s),type:"number",min:"1",max:"60",class:"form-input"},null,512),[[$,u.session_renewal_ttl,void 0,{number:!0}]]),e[17]||(e[17]=t("span",{class:"input-suffix"},"分钟",-1))])]),t("div",Tt,[e[20]||(e[20]=t("label",null,"不可用标记 TTL",-1)),t("div",$t,[y(t("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>u.unavailable_ttl=s),type:"number",min:"1",max:"60",class:"form-input"},null,512),[[$,u.unavailable_ttl,void 0,{number:!0}]]),e[19]||(e[19]=t("span",{class:"input-suffix"},"分钟",-1))])]),t("div",Bt,[e[22]||(e[22]=t("label",null,"并发计数 TTL",-1)),t("div",St,[y(t("input",{"onUpdate:modelValue":e[3]||(e[3]=s=>u.concurrency_ttl=s),type:"number",min:"1",max:"60",class:"form-input"},null,512),[[$,u.concurrency_ttl,void 0,{number:!0}]]),e[21]||(e[21]=t("span",{class:"input-suffix"},"分钟",-1))])]),t("div",Ut,[t("button",{class:"btn btn-primary",onClick:et,disabled:B.value},l(B.value?"保存中...":"保存配置"),9,Vt)])])],2)]),t("div",Pt,[t("div",Nt,[t("button",{class:x(["tab",{active:b.value==="sessions"}]),onClick:e[4]||(e[4]=s=>D("sessions"))},[e[24]||(e[24]=yt('<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-0c07b2ff><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" data-v-0c07b2ff></path><circle cx="9" cy="7" r="4" data-v-0c07b2ff></circle><path d="M23 21v-2a4 4 0 00-3-3.87" data-v-0c07b2ff></path><path d="M16 3.13a4 4 0 010 7.75" data-v-0c07b2ff></path></svg>',1)),C(" 会话列表 ("+l(m.value)+") ",1)],2),t("button",{class:x(["tab",{active:b.value==="unavailable"}]),onClick:e[5]||(e[5]=s=>D("unavailable"))},[e[25]||(e[25]=t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("circle",{cx:"12",cy:"12",r:"10"}),t("line",{x1:"4.93",y1:"4.93",x2:"19.07",y2:"19.07"})],-1)),C(" 不可用账号 ("+l(U.value.length)+") ",1)],2),t("button",{class:x(["tab",{active:b.value==="concurrency"}]),onClick:e[6]||(e[6]=s=>D("concurrency"))},[...e[26]||(e[26]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("path",{d:"M3 3v18h18"}),t("path",{d:"M18 9l-5 5-4-4-3 3"})],-1),C(" 并发统计 ",-1)])],2)])]),y(t("div",Ft,[t("div",zt,[t("div",It,[t("div",Et,[e[27]||(e[27]=t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("circle",{cx:"11",cy:"11",r:"8"}),t("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})],-1)),y(t("input",{"onUpdate:modelValue":e[7]||(e[7]=s=>S.value=s),type:"text",placeholder:"搜索会话/账号/API Key...",onInput:tt},null,544),[[$,S.value]])]),t("button",{class:"btn btn-danger btn-sm",onClick:at,disabled:g.value.length===0}," 清除全部 ",8,Kt)]),t("div",Dt,[t("table",Ht,[e[29]||(e[29]=t("thead",null,[t("tr",null,[t("th",null,"会话ID"),t("th",null,"账号"),t("th",null,"API Key"),t("th",null,"平台"),t("th",null,"模型"),t("th",null,"绑定时间"),t("th",null,"最后使用"),t("th",null,"剩余时间"),t("th",null,"客户端IP"),t("th",null,"操作")])],-1)),L.value?_("",!0):(a(),o("tbody",Rt,[(a(!0),o(R,null,j(Q.value,s=>(a(),o("tr",{key:s.session_id},[t("td",null,[t("code",jt,l(Y(s.session_id)),1)]),t("td",null,[t("span",qt,l(P(s.account_id)),1)]),t("td",null,[s.api_key_id?(a(),o("code",Wt,l(G(s.api_key_id)),1)):(a(),o("span",Gt,"-"))]),t("td",null,[t("span",Jt,l(s.platform||"-"),1)]),t("td",Ot,l(s.model||"-"),1),t("td",null,l(q(s.bound_at)),1),t("td",null,l(q(s.last_used_at)),1),t("td",null,[t("span",{class:x(["ttl-badge",Z(s.remaining_ttl)])},l(W(s.remaining_ttl)),3)]),t("td",null,l(s.client_ip||"-"),1),t("td",null,[t("button",{class:"action-btn danger",onClick:i=>lt(s.session_id),title:"移除"},[...e[28]||(e[28]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),t("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])],8,Qt)])]))),128))]))]),L.value?(a(),o("div",Xt,[...e[30]||(e[30]=[t("div",{class:"loading-spinner"},null,-1),t("span",null,"加载中...",-1)])])):_("",!0),!L.value&&g.value.length===0?(a(),o("div",Yt,[...e[31]||(e[31]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[t("path",{d:"M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"}),t("circle",{cx:"9",cy:"7",r:"4"})],-1),t("span",null,"暂无活跃会话",-1)])])):_("",!0)]),m.value>0?(a(),o("div",Zt,[t("div",te,"共 "+l(m.value)+" 条记录",1),t("div",ee,[y(t("select",{"onUpdate:modelValue":e[8]||(e[8]=s=>w.value=s),onChange:f,class:"page-size-select"},[...e[32]||(e[32]=[t("option",{value:20},"20 条/页",-1),t("option",{value:50},"50 条/页",-1),t("option",{value:100},"100 条/页",-1)])],544),[[_t,w.value]]),t("div",ne,[t("button",{class:"page-btn",disabled:k.value<=1,onClick:e[9]||(e[9]=s=>{k.value--,f()})},[...e[33]||(e[33]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("polyline",{points:"15,18 9,12 15,6"})],-1)])],8,se),t("span",le,l(k.value)+" / "+l(Math.ceil(m.value/w.value)||1),1),t("button",{class:"page-btn",disabled:k.value>=Math.ceil(m.value/w.value),onClick:e[10]||(e[10]=s=>{k.value++,f()})},[...e[34]||(e[34]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("polyline",{points:"9,18 15,12 9,6"})],-1)])],8,ae)])])])):_("",!0)])],512),[[H,b.value==="sessions"]]),y(t("div",oe,[t("div",ie,[t("div",{class:"card-toolbar"},[e[36]||(e[36]=t("span",{class:"toolbar-title"},"临时不可用账号",-1)),t("button",{class:"btn btn-outline btn-sm",onClick:N},[...e[35]||(e[35]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("polyline",{points:"23,4 23,10 17,10"}),t("path",{d:"M20.49 15a9 9 0 11-2.12-9.36L23 10"})],-1),C(" 刷新 ",-1)])])]),t("div",re,[t("table",ue,[e[37]||(e[37]=t("thead",null,[t("tr",null,[t("th",null,"账号"),t("th",null,"原因"),t("th",null,"剩余时间"),t("th",null,"操作")])],-1)),M.value?_("",!0):(a(),o("tbody",ce,[(a(!0),o(R,null,j(U.value,s=>(a(),o("tr",{key:s.account_id},[t("td",null,[t("span",de,l(P(s.account_id)),1)]),t("td",ve,l(s.reason),1),t("td",null,[t("span",fe,l(W(s.remaining_ttl)),1)]),t("td",null,[t("button",{class:"btn btn-success btn-sm",onClick:i=>it(s.account_id)}," 恢复 ",8,pe)])]))),128))]))]),M.value?(a(),o("div",be,[...e[38]||(e[38]=[t("div",{class:"loading-spinner"},null,-1),t("span",null,"加载中...",-1)])])):_("",!0),!M.value&&U.value.length===0?(a(),o("div",ge,[...e[39]||(e[39]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[t("path",{d:"M22 11.08V12a10 10 0 11-5.93-9.14"}),t("polyline",{points:"22,4 12,14.01 9,11.01"})],-1),t("span",null,"暂无不可用账号",-1)])])):_("",!0)])])],512),[[H,b.value==="unavailable"]]),y(t("div",ye,[t("div",_e,[t("div",me,[t("div",he,[t("span",ke,"账号并发 ("+l(K.value.length)+")",1)]),t("div",we,[t("table",Ce,[e[40]||(e[40]=t("thead",null,[t("tr",null,[t("th",null,"账号"),t("th",null,"并发"),t("th",null,"操作")])],-1)),t("tbody",null,[(a(!0),o(R,null,j(K.value,s=>(a(),o("tr",{key:s.account_id},[t("td",null,l(P(s.account_id)),1),t("td",null,[t("span",{class:x(X(s.concurrency,s.max_concurrency))},l(s.concurrency),3),C(" / "+l(s.max_concurrency),1)]),t("td",null,[t("button",{class:"btn btn-danger btn-xs",onClick:i=>rt(s.account_id)}," 重置 ",8,xe)])]))),128))])]),K.value.length===0?(a(),o("div",Le,[...e[41]||(e[41]=[t("span",null,"暂无数据",-1)])])):_("",!0)])])])],512),[[H,b.value==="concurrency"]]),(a(),gt(ht,{to:"body"},[T.value?(a(),o("div",{key:0,class:"modal-overlay",onClick:e[12]||(e[12]=mt(s=>T.value=!1,["self"]))},[t("div",Ae,[e[42]||(e[42]=t("div",{class:"modal-header danger"},[t("div",{class:"danger-icon"},[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("path",{d:"M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"}),t("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),t("line",{x1:"12",y1:"17",x2:"12.01",y2:"17"})])]),t("h2",null,"确认清除")],-1)),e[43]||(e[43]=t("div",{class:"modal-body"},[t("p",{class:"delete-message"},"确定要清除所有会话缓存吗？此操作不可撤销。")],-1)),t("div",Me,[t("button",{class:"btn btn-secondary",onClick:e[11]||(e[11]=s=>T.value=!1)},"取消"),t("button",{class:"btn btn-danger",onClick:ot},"确认清除")])])])):_("",!0)]))]))}},Se=vt(Te,[["__scopeId","data-v-0c07b2ff"]]);export{Se as default};
